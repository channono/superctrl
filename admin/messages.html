<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .message-content {
            max-height: 100px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .message-content.expanded {
            max-height: none;
        }
        .sort-icon {
            cursor: pointer;
        }
        .sort-icon i {
            font-size: 0.8em;
        }
        .card.selected {
            border: 2px solid #0d6efd;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Message Management</h2>
        
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4">
                    <label>Date Range:</label>
                    <input type="date" id="startDate" class="form-control" onchange="filterMessages()">
                </div>
                <div class="col-md-4">
                    <label>To:</label>
                    <input type="date" id="endDate" class="form-control" onchange="filterMessages()">
                </div>
                <div class="col-md-4">
                    <label>Search:</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search messages..." onkeyup="filterMessages()">
                </div>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div class="mb-3">
            <button class="btn btn-primary" onclick="selectAll()">Select All</button>
            <button class="btn btn-danger" onclick="deleteSelected()">Delete Selected</button>
            <button class="btn btn-success" onclick="exportToCSV()">Export to CSV</button>
            <button class="btn btn-secondary" onclick="sortMessages('timestamp')">Sort by Date</button>
        </div>

        <div id="messagesContainer"></div>
    </div>

    <script>
        let messages = [];
        let currentSort = { field: 'timestamp', ascending: false };
        
        function selectAll() {
            const cards = document.querySelectorAll('.message-card');
            const allSelected = Array.from(cards).every(card => card.classList.contains('selected'));
            
            cards.forEach(card => {
                if (allSelected) {
                    card.classList.remove('selected');
                } else {
                    card.classList.add('selected');
                }
            });
        }

        function toggleSelection(card) {
            card.classList.toggle('selected');
        }

        async function deleteSelected() {
            const selectedCards = document.querySelectorAll('.message-card.selected');
            if (selectedCards.length === 0) {
                alert('Please select messages to delete');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedCards.length} message(s)?`)) {
                return;
            }

            const messageIds = Array.from(selectedCards).map(card => card.dataset.messageId);

            try {
                const response = await fetch('/api/delete-message', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ messageIds })
                });

                if (!response.ok) {
                    throw new Error('Failed to delete messages');
                }

                // Remove deleted messages from UI and array
                messageIds.forEach(id => {
                    document.querySelector(`[data-message-id="${id}"]`).remove();
                    messages = messages.filter(m => m.id !== id);
                });

                alert('Messages deleted successfully');
            } catch (error) {
                console.error('Error deleting messages:', error);
                alert('Failed to delete messages. Please try again.');
            }
        }

        function exportToCSV() {
            // Get visible messages (respecting filters)
            const visibleCards = document.querySelectorAll('.message-card:not([style*="display: none"])');
            const visibleMessages = Array.from(visibleCards).map(card => {
                const id = card.dataset.messageId;
                return messages.find(m => m.id === id);
            });

            // Create CSV content
            const csvContent = [
                ['Date', 'Name', 'Email', 'Subject', 'Message'],
                ...visibleMessages.map(msg => [
                    new Date(msg.timestamp).toLocaleString(),
                    msg.name,
                    msg.email,
                    msg.subject,
                    msg.message
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `messages_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function filterMessages() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            const cards = document.querySelectorAll('.message-card');
            cards.forEach(card => {
                const messageId = card.dataset.messageId;
                const message = messages.find(m => m.id === messageId);
                
                let show = true;

                // Date filter
                if (startDate && new Date(message.timestamp) < new Date(startDate)) show = false;
                if (endDate && new Date(message.timestamp) > new Date(endDate + 'T23:59:59')) show = false;

                // Text search
                if (searchText && !Object.values(message).some(val => 
                    val.toString().toLowerCase().includes(searchText)
                )) show = false;

                card.style.display = show ? '' : 'none';
            });
        }

        function displayMessages(sortedMessages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            sortedMessages.forEach(message => {
                const card = document.createElement('div');
                card.className = 'card mb-3 message-card';
                card.dataset.messageId = message.id;
                card.onclick = () => toggleSelection(card);
                
                card.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${message.name}</strong>
                            <span class="text-muted">${new Date(message.timestamp).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <h5>${message.subject}</h5>
                        <p>${message.message}</p>
                        <p class="text-muted mb-0">
                            <small>Email: ${message.email}</small>
                        </p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function loadMessages() {
            try {
                const apiUrl = window.location.hostname === 'localhost' 
                    ? '/api/messages'
                    : '/api/messages';

                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Failed to load messages');
                }
                
                messages = await response.json();
                sortMessages('timestamp');
            } catch (error) {
                console.error('Error loading messages:', error);
                alert('Failed to load messages. Please try again.');
            }
        }

        function sortMessages(field) {
            if (currentSort.field === field) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort = { field, ascending: true };
            }

            messages.sort((a, b) => {
                let comparison = 0;
                if (field === 'timestamp') {
                    comparison = new Date(a[field]) - new Date(b[field]);
                } else {
                    comparison = a[field].localeCompare(b[field]);
                }
                return currentSort.ascending ? comparison : -comparison;
            });

            displayMessages(messages);
        }

        // Load messages when page loads
        document.addEventListener('DOMContentLoaded', loadMessages);
    </script>
</body>
</html>
